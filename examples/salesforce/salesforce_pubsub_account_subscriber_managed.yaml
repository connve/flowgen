flow:
  require_leader_election: true
  name: salesforce_pubsub_account_subscriber_managed
  tasks:

    # Subscribe to Salesforce PubSub API on a given topic.
    # This example uses a Salesforce-managed durable subscription.
    # The subscription is automatically managed by Salesforce, however it does
    # require creation of managed subscription by Tooling API.
    - salesforce_pubsub_subscriber:
        name: start_subscription
        credentials_path: /etc/sfdc/credentials.json
        topic:
          name: /data/AccountChangeEvent
          durable_consumer_options:
            enabled: true
            managed_subscription: true
            name: salesforce_pubsub_account_subscriber_managed

    # Publish events to NATS for extra durability.
    - nats_jetstream_publisher:
        name: publish_events
        credentials_path: /etc/nats/credentials.json
        subject: pubsub.data.{{event.subject}}
        stream:
          create_or_update: true
          name: salesforce
          description: "Salesforce messaging stream for platform events, query results etc."
          subjects: ["pubsub.>",]
          max_age_secs: 86400
          retention: limits
          discard_policy: old
