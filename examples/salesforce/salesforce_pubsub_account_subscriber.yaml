flow:
  require_leader_election: true
  name: salesforce_pubsub_account_subscriber
  tasks:

    # Subscribe to Salesforce PubSub API on a given topic.
    # This example uses a non-managed durable subscription.
    # The subscription replay ID is managed by configured cache.
    - salesforce_pubsub_subscriber:
        name: start_subscription
        credentials_path: /etc/sfdc/credentials.json
        topic:
          name: /data/AccountChangeEvent
          durable_consumer_options:
            enabled: true
            managed_subscription: false
            name: salesforce_pubsub_account_subscriber
            # replay_preset: EARLIEST
            # replay_present is set as LATEST by default if no reply_id is provided
            # or set to CUSTOM if it is provided. It can also be set to EARLIEST if
            # required to get events from before last known reply_id.

    # Publish events to NATS for extra durability.
    - nats_jetstream_publisher:
        name: publish_events
        credentials_path: /etc/nats/credentials.json
        url: "localhost:4222"
        subject: pubsub.data.{{event.subject}}
        stream:
          create_or_update: true
          name: salesforce
          description: "Salesforce messaging stream for platform events, query results etc."
          subjects: ["pubsub.>",]
          max_age_secs: 86400
          retention: limits
          discard_policy: old

