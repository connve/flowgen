flow:
  name: bigquery_query_basic
  require_leader_election: true
  tasks:

    # Generate triggers the flow once after 10 seconds.
    - generate:
        name: trigger
        interval: 10s
        count: 1

    # BigQuery query executes a simple SELECT query.
    # Results are returned as Arrow RecordBatch for efficient columnar processing.
    - bigquery_query:
        name: fetch_orders
        credentials_path: /etc/gcp/credentials.json
        project_id: my-project-id
        query: "SELECT order_id, customer_id, amount, order_date FROM `my-project-id.analytics.orders` WHERE order_date >= '2024-01-01' ORDER BY order_date DESC"

    # Publish Arrow RecordBatch results directly to NATS (native Arrow support).
    - nats_jetstream_publisher:
        name: publish_results
        credentials_path: /etc/nats/credentials.json
        url: "localhost:4222"
        subject: bigquery.orders.fetched
        stream:
          create_or_update: true
          name: bigquery
          description: "BigQuery query results stream"
          subjects: ["bigquery.>"]
          max_age_secs: 86400
          retention: limits
          discard_policy: old
