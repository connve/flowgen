flow:
  name: bigquery_query_parameterized
  require_leader_election: true
  tasks:

    # Run this task on specified intervals to fetch completed orders.
    - generate:
        name: generate_jobs
        interval: 300s

    # BigQuery query with parameterized SQL for SQL injection protection.
    # Parameters are type-safe and properly escaped by BigQuery client.
    # Results are returned as Arrow RecordBatch for efficient columnar processing.
    - bigquery_query:
        name: fetch_completed_orders
        credentials_path: /etc/gcp/credentials.json
        project_id: my-project-id
        query: "SELECT order_id, customer_id, amount, order_date FROM `my-project-id.analytics.orders` WHERE status = @status AND order_date >= @start_date ORDER BY order_date DESC"
        parameters:
          status: "completed"
          start_date: "2024-01-01"
        max_results: 1000
        timeout: "5m"

    # Publish Arrow RecordBatch results directly to NATS stream (native Arrow support).
    - nats_jetstream_publisher:
        name: publish_completed_orders
        credentials_path: /etc/nats/credentials.json
        url: "localhost:4222"
        subject: bigquery.orders.completed
        stream:
          create_or_update: true
          name: bigquery
          description: "BigQuery query results stream"
          subjects: ["bigquery.>"]
          max_age_secs: 86400
          retention: limits
          discard_policy: old
